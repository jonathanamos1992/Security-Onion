# Security Onion overview (from text)

Security Onion is a free and open platformbuilt by defenders for defenders. It includes network visibility, host visibility, intrusion detection honeypots, log management, and case management.

### network visibility - signature based detection via Suricata
protocol metadata and file extraction - either Zeek or Suricata
full packet capture - Stenographer
file analysis - Strelka

### host visibility
we offer the Elastic Agent which provides data collection, live queries via osquery, and centralized management using Elastic Fleet. 
Intrusion detection honeypots based on OpenCanary can be added to your deployment for even
more enterprise visibility. All of these logs flow into Elasticsearch and we’ve built our own user interfaces for alerts, dashboards, threat hunting, case management, and grid management.


In the diagram below, we see Security Onion in a traditional enterprise network with a firewall, workstations, and servers. You can use Security Onion to monitor north/south traffic to detect an adversary entering an environment,establishing command-and-control (C2), or perhaps data exfiltration. You’ll probably also want to monitor east/west traffic to detect lateral movement. As more and more of our network traffic becomes encrypted, it’s important to fill inthose blind spots with additional visibility in the form of endpoint telemetry. Security Onion can consume logs from your servers and workstations so that you can then hunt across all of your network and host logs at the same time.

## Network Visibility

### Intrusion Detection

Security Onion generates NIDS (Network Intrusion Detection System) alerts by monitoring your network traffic and looking for specific fingerprints and identifiers that match known malicious, anomalous, or otherwise suspicious traffic
NIDS alerts are generated by Suricata.

### Network Metadata

Unlike signature-based intrusion detection that looks for specific needles in the haystack of data, network metadata provides you with logs of connections and standard protocols like DNS, HTTP, FTP, SMTP, SSH, and SSL. This provides a real depth and visibility into the context of data and events on your network. Security Onion provides network metadata using your choice of either Zeek or Suricata.

### Full Packet Capture

Full packet capture is like a video camera for your network, but better because not only can it tell us who came andwent, but also exactly where they went and what they brought or took with them (exploit payloads, phishing emails, file exfiltration).
Full packet capture is recorded by Stenographer

### File Analysis

As Zeek and Suricata are monitoring your network traffic, they can extract files transferred across the network. Strelka can then analyze those files and provide additional metadata.

### Intrusion Detection Honeypot (IDH)

We also have an Intrusion Detection Honeypot node that allows you to build a node that mimics services. Connections to these services automatically generate alerts.

## Host Visibility

In addition to network visibility, Security Onion provides endpoint visibility via the Elastic Agent which provides data collection, live queries via osquery, and centralized management using Elastic Fleet.

For devices like firewalls and routers that don’t support the installation of agents, Security Onion can consume standard Syslog.

 ### Analysis Tools

### Workflow

## analysis tools work together to provide efficient and comprehensive analysis capabilities. For example, here’s one potential workflow:

• Go to the Alerts page and review any unacknowledged alerts.
• Review Dashboards for anything that looks suspicious.
• Once you’ve found something that you want to investigate, you might want to pivot to Hunt to expand your search
and look for additional logs relating to the source and destination IP addresses.
• If any of those alerts or logs look interesting, you might want to pivot to PCAP to review the full packet capture
for the entire stream.
• Depending on what you see in the stream, you might want to send it to CyberChef for further analysis and
decoding.
• Escalate alerts and logs to Cases and document any observables. Pivot to Hunt to cast a wider net for those
observables.
• Develop a play in Playbook that will automatically alert on observables moving forward and update your coverage
in ATT&CK Navigator.
• If you have the Elastic Agent deployed, then you might want to search for additional host logs or run live queries
against your endpoints using osquery.
• Finally, return to Cases and document the entire investigation and close the case.

### Conclusion

# Installation

We're go to create a new VM using the Linux family and Version of Oracle 9


### Note
Since we do not have a RAID array due to our RAID controller not being compatible with our hard drives, we ran into an issue of not having enoguh disk space when attempting to create Security Onion Manager
<img width="1129" height="690" alt="image" src="https://github.com/user-attachments/assets/bd02235a-6296-4c9e-bfcc-a98d02787187" />

At the moment we don't know if port groups Security Onion that is in Management Port Group can reach our Domain Controller Windows Server 2022 in Domain Services via Palo Alto. 

ChatGPT says in the meantime we can use our Palo Alto management interface (192.168.3.1) and change later.

### Since we're not 100% sure those paths are routable, we'll stick with default
8.8.8.8,8.8.4.4

<img width="946" height="595" alt="image" src="https://github.com/user-attachments/assets/8a341003-86f1-4829-8b07-5c6d4f718359" />

<img width="1027" height="794" alt="image" src="https://github.com/user-attachments/assets/ddc2821c-a799-448f-8e12-2db8825c410a" />

<img width="1026" height="795" alt="image" src="https://github.com/user-attachments/assets/4014d2c2-7a93-4020-996c-be745cc5778c" />

Login localhost

<img width="1024" height="792" alt="image" src="https://github.com/user-attachments/assets/6c713f89-a7b8-4e12-8908-af602872b2e4" />

<img width="1022" height="788" alt="image" src="https://github.com/user-attachments/assets/a69b6dcf-cce1-48ae-9650-7ccbf2e269dc" />

<img width="1022" height="794" alt="image" src="https://github.com/user-attachments/assets/f431f166-bb7d-48a5-a801-25f279227dce" />

<img width="1021" height="788" alt="image" src="https://github.com/user-attachments/assets/4dfd2aae-8c3b-44a6-ba65-b89616982837" />

<img width="1025" height="804" alt="image" src="https://github.com/user-attachments/assets/5e4eca8e-9949-4bc7-a790-4eeed103e61b" />

<img width="1025" height="790" alt="image" src="https://github.com/user-attachments/assets/323f2063-7e7a-4b0f-bae6-6647abbbf4c1" />

<img width="1024" height="797" alt="image" src="https://github.com/user-attachments/assets/1cb1fb28-4a33-4c4d-999b-45f64d9054f0" />

<img width="1028" height="790" alt="image" src="https://github.com/user-attachments/assets/5b6a5a92-f8a7-497c-81ea-99d8a6e04254" />

<img width="1025" height="791" alt="image" src="https://github.com/user-attachments/assets/49f1c167-f763-47ef-90bf-611f188e4853" />

<img width="1024" height="782" alt="image" src="https://github.com/user-attachments/assets/b0706190-f72d-4276-bd75-c48711f419b8" />

<img width="1019" height="789" alt="image" src="https://github.com/user-attachments/assets/39e8af12-e61f-41be-b826-e405f3ca7abb" />

<img width="1024" height="787" alt="image" src="https://github.com/user-attachments/assets/30adfc80-d149-430e-9cf3-8c352293eb1f" />

<img width="1020" height="792" alt="image" src="https://github.com/user-attachments/assets/9205e034-70f8-493f-a73a-c9d89dd3e2af" />

<img width="1025" height="788" alt="image" src="https://github.com/user-attachments/assets/0cfbe8c5-9f26-4a5c-82a9-448f243ba6d9" />

<img width="1018" height="792" alt="image" src="https://github.com/user-attachments/assets/86ea3b65-fbbb-42bb-9e50-124362eca9ad" />

<img width="1018" height="794" alt="image" src="https://github.com/user-attachments/assets/0d935888-5beb-4191-8916-45d11da9f7a0" />

<img width="1021" height="785" alt="image" src="https://github.com/user-attachments/assets/15c0ea6e-f477-4707-a1da-be9eaa7a59a0" />

<img width="1016" height="782" alt="image" src="https://github.com/user-attachments/assets/6f4ce0cd-6e41-49d8-8927-6b4adc09a178" />

<img width="1022" height="793" alt="image" src="https://github.com/user-attachments/assets/adc07959-864b-40b6-8ce7-55c83d7ddc44" />

<img width="1026" height="790" alt="image" src="https://github.com/user-attachments/assets/8983a4aa-40e4-495a-9e27-82977f76db9c" />

<img width="1025" height="791" alt="image" src="https://github.com/user-attachments/assets/12ad90fb-556c-4894-b2ae-83ac3199978d" />

<img width="1028" height="786" alt="image" src="https://github.com/user-attachments/assets/0294bb3d-c425-4879-b91a-6e657c0d15cf" />

<img width="1025" height="797" alt="image" src="https://github.com/user-attachments/assets/c6101d94-9401-484c-96df-d411f96fcb34" />

### New VM for Security Onion Sensor

<img width="941" height="594" alt="image" src="https://github.com/user-attachments/assets/06744ecb-c4e0-4a09-8065-60f558efade0" />

<img width="940" height="592" alt="image" src="https://github.com/user-attachments/assets/99f9ccbc-6b7e-4adf-bc00-bbde7d9fa139" />

<img width="954" height="595" alt="image" src="https://github.com/user-attachments/assets/e27f8af7-d761-4aa0-b5f5-deee78094426" />

<img width="940" height="589" alt="image" src="https://github.com/user-attachments/assets/fc28f617-d727-4a78-953a-f75332ad14c5" />

We are storing the VM on Datastore 3 and pulling the iso from Datastore 2

We have to change our sniffing port group NIC into promiscuous mode

<img width="3046" height="1111" alt="image" src="https://github.com/user-attachments/assets/905aab80-7f7b-4d68-b751-5afdb2191c71" />

<img width="853" height="93" alt="image" src="https://github.com/user-attachments/assets/88500f6a-39f5-49ef-a296-f540c07f47f3" />

<img width="513" height="184" alt="image" src="https://github.com/user-attachments/assets/de98bbd0-d324-4134-bab4-0e10a717543e" />

<img width="749" height="84" alt="image" src="https://github.com/user-attachments/assets/9322ed65-1fb9-4c3c-ac21-cb6df03024a1" />

<img width="446" height="163" alt="image" src="https://github.com/user-attachments/assets/d0fcae7e-4f27-4a59-9085-4b84e2573ada" />

<img width="1027" height="794" alt="image" src="https://github.com/user-attachments/assets/d9f03ad8-60f0-4ff2-9ae7-382bf01dab67" />

<img width="1027" height="792" alt="image" src="https://github.com/user-attachments/assets/2f8eb2e1-c1b0-428c-9d48-c9dc7e0794aa" />

<img width="1019" height="787" alt="image" src="https://github.com/user-attachments/assets/a467bd26-89bf-458f-b965-659ee074d471" />

<img width="1025" height="789" alt="image" src="https://github.com/user-attachments/assets/f9090f90-c857-48be-8602-9bc319288ef9" />


<img width="703" height="171" alt="image" src="https://github.com/user-attachments/assets/78aed57f-679c-4693-a01e-488ae080b1a2" />
Choose the same NIC as our TOOLS-PG
<img width="1032" height="791" alt="image" src="https://github.com/user-attachments/assets/355660d7-af84-40f2-b80d-07eeac7768e9" />

<img width="1022" height="787" alt="image" src="https://github.com/user-attachments/assets/f19798e4-e392-400b-8967-72b9090f18e8" />

<img width="1027" height="788" alt="image" src="https://github.com/user-attachments/assets/f69a4d86-da66-4f4d-a739-378b378bcaec" />

<img width="1021" height="798" alt="image" src="https://github.com/user-attachments/assets/84b70025-c482-4067-94fe-ab008c7fb93e" />

<img width="1029" height="791" alt="image" src="https://github.com/user-attachments/assets/f9bd12c5-5619-4f14-b329-eb5948db7db4" />

<img width="1030" height="791" alt="image" src="https://github.com/user-attachments/assets/3c024fd0-8e4b-4a87-bdfd-92ace25f339d" />

<img width="1026" height="791" alt="image" src="https://github.com/user-attachments/assets/b388e455-0968-42a7-801f-0906e04cf2c8" />

<img width="1027" height="793" alt="image" src="https://github.com/user-attachments/assets/379d7e6d-1042-471d-8687-9aa545b1c04d" />

Hit Enter

We get this screen

<img width="1027" height="805" alt="image" src="https://github.com/user-attachments/assets/4c25eba3-3be9-4f2a-aa08-2e98aa10969d" />

### enable connectivity between the Manager and Sensor Nodes
Web into the SecOnion Manager -> Administration -> Configuration and scroll down to Firewall -> Sensor and input the IP of the sensor node

<img width="1345" height="903" alt="image" src="https://github.com/user-attachments/assets/8386046d-2124-4bc6-9eb0-460dc1e528cd" />

<img width="2217" height="1053" alt="image" src="https://github.com/user-attachments/assets/6d0605bb-0d90-4b49-8a10-47ebfa8dbb12" />

### Let's try this command
<img width="1027" height="799" alt="image" src="https://github.com/user-attachments/assets/640c1188-46ef-4371-b513-98cb79d948cc" />

### We waited for that command to finsh and got this screen showing it worked
<img width="1028" height="803" alt="image" src="https://github.com/user-attachments/assets/54470127-369a-49b5-b255-e211299be2ff" />

### Now we're able to add our sniffer NIC
<img width="1039" height="793" alt="image" src="https://github.com/user-attachments/assets/73b3c232-91ac-4803-bfc2-1bae1a70bff3" />

<img width="1031" height="805" alt="image" src="https://github.com/user-attachments/assets/d3e1b817-de07-4355-acd9-c8dcc0fa619f" />

<img width="1038" height="790" alt="image" src="https://github.com/user-attachments/assets/6c7149cc-be2b-477e-8936-ac84dd7a96bf" />

<img width="1034" height="791" alt="image" src="https://github.com/user-attachments/assets/855f1081-79c9-4d61-9786-4ffbbaffb11d" />

### From Security Onion Web GUI

<img width="2207" height="1061" alt="image" src="https://github.com/user-attachments/assets/1ef96a37-2fa5-4dbf-80d0-9741a3066a78" />

<img width="2203" height="1063" alt="image" src="https://github.com/user-attachments/assets/958794fc-d305-46fe-bc90-462b89906503" />

<img width="2210" height="1054" alt="image" src="https://github.com/user-attachments/assets/a7b74db9-2ab0-43b4-bdb6-98464ac28dc2" />

### Finally, you can console into the SecO Sensor and use the "sudo so-status" command to check the service status and health of the node

<img width="1025" height="396" alt="image" src="https://github.com/user-attachments/assets/ad0b905e-1f0c-4496-bd9b-80d9bdd04876" />

# Security Onion Essentials 2024 Course

<img width="1198" height="669" alt="image" src="https://github.com/user-attachments/assets/65f98c6e-7669-4317-ad6b-0ae7b967b67b" />

### Operating System - Oracle Linux
- RPM-based linux distribution
- RPM-based Linux distribution is a Linux OS that uses RPM packages (.rpm files) for installing, updating, and removing software.
- Software is managed with tools like:
dnf
yum
rpm
RPM = Red Hat Package Manager

### Infrastructure:
Most subsystems of Sec Onion are containerized and run under Docker
With organization and configuration of grid managed by Salt

Grid - A group of Security Onion nodes (manager, sensor, search, etc.) that work together as one unified system.

What the grid does:
Shares configuration
Distributes data and workloads
Lets all nodes operate under one management plane

Data moving around between components is handled by Elastic Agent, Logstash, and Redis
Elasticsearch - parse and stores data for later retrieval

InfluxDB - Produces, retains and visualizes operational data on your Security Onion enviornment to trach and alarm

This infrastucture layer exists to process Network and Host data, which is what's produced by next layer

### Network & Host Data:
Elastic Agent - Collects logs from endpoints and send them into Security Onion for Processing
Can include logs generated by the nodes in Security Onion grid or any endpoints we want telemetry from.

***
Telemetry - automatically collected data about activity and performance that systems send for monitoring and analysis.
Telemetry = systems reporting what they’re doing, metadata about behavior
Data is what was sent.
Metadata is how, when, where, and between whom it was sent.
***
OSQuery - Allow analysts to run SQL-style queries across all of the elastic agents to retrieve data in real time

Stenographer - full packet capture component that will record every single byte traversing the network segment that you're monitoring for later retrieval and analysis

Zeek - Generator of network metadata, including both netflow style connection records and more expansive logging for IT and OT network protocols.

IT (Information Technology)
Systems that handle data, computing, and communication.

OT (Operational Technology)
Systems that control or monitor physical processes.

Examples:

Industrial control systems (ICS)
PLCs
SCADA systems
Power grids, water treatment, manufacturing lines

Suricata - Network Intrusion Detection System (IDS)
Checks network flows for traffic that matches singatures 
Also capable of packet capture and metadata generation

Network flow is a summary record of a communication session between two endpoints on a network.

Strelka - Runs Yara analysis rules against files extracted from Network traffic, alterting if something seems to be malicious in nature.

### Analyst Tools:

Alerts page - provides a queue of suspicious events for your analyst to triage and investigate

Cases - suspicious events can be recorded for future review.

Hunt and Dashboard tools - provide quick analysis capabilities for stacking and sorting ingested log data for investigations or threat hunting.

Detections - allow analysts to write new alerting rules for deployment to the grid, closing the loop and ensuring indicator discovered in the threat hunt will raise an alert in the future.

Cyberchef - flexbible tool for encoding/decoding and manipulating data

Elastic fleet interface for managing your elastic agent deployment 

Kibana - Builds more advanced visualizations and queries against collected data.

### Intro to analyst tools

Alerts - Intended to be a central hub for all the malicious events detected in your enviornment.

### 
We wanted to check to see if our sensor was placed correctly so we ran 'ip addr' to check

<img width="987" height="614" alt="image" src="https://github.com/user-attachments/assets/a743ae26-2275-47e6-9e51-70ccaf1ba08b" />

## Breakdown

### lo (loopback)
Internal-only interface
Used by the OS to talk to itself
127.0.0.1
Not related to networking, sensors, or alerts
You can ignore this for Security Onion placement.
<img width="762" height="70" alt="image" src="https://github.com/user-attachments/assets/6ee74130-1f74-4f4d-8f17-00376390ce03" />

### Management interface (for the sensor) ens34 (this one matters)
inet 192.168.100.99/24
This confirms management IP (for the sensor)

This is how the manager talks to the sensor
Used for: Web UI, Logs shipping, SSH
NOT used for traffic inspection
<img width="785" height="119" alt="image" src="https://github.com/user-attachments/assets/139175cc-5497-4c1b-ae7d-a1f7135e27f0" />

### Monitor interface ens35 (this is the key)
3: ens35: <BROADCAST,NOARP,PROMISC,SLAVE,UP,LOWER_UP> ...

Important flags:

PROMISC → sees all traffic
NOARP → does not talk on the network
SLAVE → attached to a bond

MTU 9000 (jumbo frames, common for SPAN)

This interface sniffs traffic only.

<img width="944" height="51" alt="image" src="https://github.com/user-attachments/assets/d1f9409e-67c1-4bf0-8174-873804f63056" />

Bond interface (logical grouping)
4: bond0: <BROADCAST,MULTICAST,PROMISC,MASTER,UP,LOWER_UP> ...


### bond0

Logical interface that groups monitor NICs

MASTER means ens35 is attached to it

Suricata and Zeek listen on bond0, not ens35 directly

This is what actually feeds detections

This is normal and correct.

<img width="968" height="39" alt="image" src="https://github.com/user-attachments/assets/f1ef8e99-c9e9-48b2-8153-9fe6afcf789f" />

<img width="613" height="90" alt="image" src="https://github.com/user-attachments/assets/d674dc67-fdea-419a-8bff-c7917d3f49c5" />

<img width="642" height="484" alt="image" src="https://github.com/user-attachments/assets/9e9ea496-2e54-4eab-9fc4-80d88cee284d" />

<img width="643" height="389" alt="image" src="https://github.com/user-attachments/assets/7821fb8b-fa9c-4a5d-9fed-6899b2c79c1d" />

<img width="477" height="313" alt="image" src="https://github.com/user-attachments/assets/7371e2f6-6e34-4291-bed4-c6cc3f7bcfa3" />

<img width="694" height="174" alt="image" src="https://github.com/user-attachments/assets/c0efaf3c-bad4-4650-968c-dc93ee72075a" />

### Docker bridge/sobridge (internal only)
6: sobridge:
inet 172.17.1.1/24

Internal Docker networking

Used by Security Onion containers

Not real network traffic

Ignore for sensor placement
<img width="858" height="68" alt="image" src="https://github.com/user-attachments/assets/693e6498-a215-4d13-a73a-d98c433ac8fe" />


### docker0
inet 172.17.0.1/24

Default Docker bridge

Same purpose as above

Not monitored traffic

<img width="804" height="52" alt="image" src="https://github.com/user-attachments/assets/ce13793b-950f-47d3-a40b-c755c04f20b2" />

veth* interfaces (lots of them)
veth66e02830f3f2
veth156e4ab0df34
veth68472a0df36
...


### veth interfaces

Virtual Ethernet pairs
One side in Docker container
One side on the host
Each Security Onion service gets one
Normal to see many
Not something you configure

<img width="993" height="197" alt="image" src="https://github.com/user-attachments/assets/722f63d2-6dbc-4d14-b9a2-52f707a9b59c" />

### For our lab we want to know if we'll be able to see traffic
<img width="977" height="928" alt="image" src="https://github.com/user-attachments/assets/fd6e0ed3-3f0c-4eff-90f0-5180fd6c0e61" />

<img width="855" height="902" alt="image" src="https://github.com/user-attachments/assets/3bd57da3-57d7-4564-a968-2f3969b55745" />

We're going to place our sensor to monitor traffic on our Palo Alto VM

<img width="1008" height="436" alt="image" src="https://github.com/user-attachments/assets/eb634e39-fa88-45dd-8a66-51fdad11668a" />


<img width="678" height="410" alt="image" src="https://github.com/user-attachments/assets/82d834e4-c241-4f60-882d-607a76ed7e77" />

### We want to verify we see traffic

we ran 

'sudo tcpdump -i bond0 icmp' 

and from our Ubuntu host, we pinged the 192.168.120.23 but did not see any traffic on the listening interface of the Sensor

<img width="1856" height="167" alt="image" src="https://github.com/user-attachments/assets/c4cf68c0-5a4f-41e2-ac5f-9caa004f0610" />

ChatGPT tells us to add a dedicated "monitor" NIC to the Palo Alto

Step 1 — Add the monitor NIC to the Palo Alto VM

In ESXi:

Step 1:
Power off the Palo Alto VM
Edit settings
Add Network Adapter
Connect it to the SPAN/TAP port group
Do not assign it an IP later

(We ran out of NIC spaces in Palo Alto so we are going to remove Client-PG and consolidate Legacy Port group and Internal-pg

We'll have to remove the vm's in internal from the domain.

To remove from Domain

Step 1 (only step)

On FLARE VM, log in with a local administrator account (not a domain account).
Do not remove it from the domain yet.
Reply “logged in locally” and I’ll give the next single step.

(This is just to show how to login if the bottom left still shows the domain admin)
This forces Windows to use the local SAM, not AD.

<img width="721" height="78" alt="image" src="https://github.com/user-attachments/assets/9ca98e30-27b2-4007-8c5a-1200c5ba071e" />

<img width="1416" height="901" alt="image" src="https://github.com/user-attachments/assets/20bd9422-9e44-47eb-a6c7-62ecc5bfa9a7" />

On FLARE VM:

Settings → System → About
Click Rename this PC (advanced)
Click Change
Select Workgroup
Enter a name like:
LEGACY

When prompted, enter domain admin credentials
Reboot when asked

<img width="1415" height="904" alt="image" src="https://github.com/user-attachments/assets/117c3454-20d7-4f5b-b950-e5fbf57e7074" />
<img width="1417" height="906" alt="image" src="https://github.com/user-attachments/assets/e11a3da2-3a6b-4f02-a8f5-51e6e37f2465" />
<img width="419" height="465" alt="image" src="https://github.com/user-attachments/assets/eb1b2940-3cac-4171-9a33-5ce32407144b" />
<img width="319" height="387" alt="image" src="https://github.com/user-attachments/assets/c78cc7b4-eb6b-4be8-9b22-766c3c302ecb" />
<img width="321" height="389" alt="image" src="https://github.com/user-attachments/assets/66a8386c-1124-4a4d-9e6e-23132f73d34e" />

On the domain controller:

Open Active Directory Users and Computers
Delete the old computer object (CARNAGE)
<img width="2425" height="1264" alt="image" src="https://github.com/user-attachments/assets/845967d7-f1f8-4566-9a16-295443cb05fc" />

Put FlareVM and Windows 10 on the legacy port group

<img width="401" height="447" alt="image" src="https://github.com/user-attachments/assets/27a9dce4-22f2-4abd-bcf8-e2cd6d554ed2" />

Join to domain

Settings > System > About > Rename this PC
<img width="323" height="384" alt="image" src="https://github.com/user-attachments/assets/29e7a0ca-908f-408d-a154-5711a2c68456" />

<img width="1696" height="973" alt="image" src="https://github.com/user-attachments/assets/57cc09e2-00da-4e3f-a079-8ad40be01e73" />

### Now we can remove the NIC for Internal from the Palo Alto VM and have 8 port groups

We updated our Palo Alto Zones and Interfaces

<img width="2114" height="720" alt="image" src="https://github.com/user-attachments/assets/7d7be698-4697-4c2a-a63d-f12b4afb3075" />

<img width="3430" height="742" alt="image" src="https://github.com/user-attachments/assets/53da61e4-48ab-43d9-a16a-c7a02d9daf62" />

NOw it's updated in the CLI
<img width="798" height="613" alt="image" src="https://github.com/user-attachments/assets/850a2dfb-a958-413a-9f3f-431bca6f6108" />

### Now we'll erify the Security Onion sensor is actually seeing any packets (locally)

On the Security Onion sensor, run exactly this:

'sudo tcpdump -i ens35 -nn'

we're getting something
<img width="1023" height="782" alt="image" src="https://github.com/user-attachments/assets/f711c0b1-3187-4823-9e39-d3d2e564db97" />

### From our Ubuntu linux we attempted to ping th default gateway and could not
<img width="742" height="247" alt="image" src="https://github.com/user-attachments/assets/0a6b9f7c-e7fe-4703-9970-3ce2d7de80d5" />

Leading us to believe we misconfigured something when changing the Palo Alto configurations
When we ran 'ip neigh show' we see we cannot reach our default gateway

<img width="814" height="75" alt="image" src="https://github.com/user-attachments/assets/2a7f485f-ef43-418e-8671-8d833322ad52" />

<img width="694" height="49" alt="image" src="https://github.com/user-attachments/assets/1c1e0809-3b0d-45d0-93b0-531ed4619edd" />

Solution:

<img width="766" height="374" alt="image" src="https://github.com/user-attachments/assets/884c4723-8607-4ffd-adde-94a1a96e9702" />

<img width="945" height="335" alt="image" src="https://github.com/user-attachments/assets/f6d22ccb-06f6-4a98-8d60-090a8a344564" />

'ip neigh' 
<img width="733" height="140" alt="image" src="https://github.com/user-attachments/assets/8bed5410-4fda-425a-977e-0770a12b6e2c" />

<img width="868" height="148" alt="image" src="https://github.com/user-attachments/assets/37df0703-3bff-4ee9-8bc0-6a18c7310a56" />

<img width="495" height="144" alt="image" src="https://github.com/user-attachments/assets/fd37f3aa-b10f-42d1-b88c-767f6ef7daa3" />

Now we can ping 
<img width="733" height="330" alt="image" src="https://github.com/user-attachments/assets/c8a6bcd6-b468-47cb-9428-d224d4980a0a" />

This is the updated Network Interface Table

<img width="2110" height="562" alt="image" src="https://github.com/user-attachments/assets/205cc296-0447-4f85-b65e-935e559f3dfc" />

### Okay now we routing is correct, let's switch back to Security Onion

On the Security Onion sensor, run:

'sudo tcpdump -i ens35 icmp'

### Convert ethernet1/8 into a TAP interface (Step 1)
In Palo Alto GUI:

Network → Interfaces → Ethernet

Edit ethernet1/8

Change:

Interface Type → Tap
IP → none
Zone → none (or a dedicated TAP zone if required)

<img width="744" height="303" alt="image" src="https://github.com/user-attachments/assets/cbebc768-1f71-4fc8-b37c-8a1e3fe49eae" />

Commit

<img width="639" height="168" alt="image" src="https://github.com/user-attachments/assets/9a2786c1-2050-4d65-8026-73189dfda3b8" />

Notice Link State up
<img width="1942" height="749" alt="image" src="https://github.com/user-attachments/assets/d534657a-6977-4faa-9fe9-d9aaba32fd5d" />

# Had to switch gameplans here. Our version of Palo Alto needs licensing to truly packet mirror.
# Instead we are going to install vCenter and hope for the best.
# But first we're going to back up ESXi

Step 1 — Enable SSH (confirmation step)
Host → Actions
Enable Secure Shell (SSH)

Step 2 — Connect to ESXi via SSH
From any machine that can reach the ESXi management IP (Windows, Linux, or a VM):

<img width="1120" height="618" alt="image" src="https://github.com/user-attachments/assets/51d5d484-c43a-47bd-8552-d6398c7b29f2" />

Step 3 — Back up the ESXi host configuration (supported method)
This backs up ESXi host config only (networking, users, settings).
It does not touch VMs or datastores.

3.2 Download the backup

From your browser on your PC:

Go to:

https://<ESXI_MANAGEMENT_IP>/downloads/

Download the file:

configBundle-<hostname>.tgz
Store it somewhere safe (this is your rollback safety net)

This file is what you would use if:
ESXi config gets corrupted
vCenter enrollment goes sideways
Networking breaks badly

Do this exactly:

Open a new browser tab

Go to:

https://192.168.3.7/ui

Log in as:

root

Do not close this tab

Then (same browser):

Open another tab

Paste this exact URL:
https://192.168.3.7/downloads/52b6d7d1-678c-6f0e-64d2-672f77806f94/configBundle-Olympus.lan.tgz
It should download immediately

<img width="376" height="143" alt="image" src="https://github.com/user-attachments/assets/0bd60e67-5f94-4bb2-b8ea-bc98ac76a7cb" />

### What still needs to be backed up

We still need VM-level backups:

Step 7 — Open the datastore and locate VM folders
Do only this:

In the ESXi Host Client, go to Storage
Click Datastore1 (or the datastore where your VMs live)
Click Browse

You should see one folder per VM (for all 16 VMs)

Step 8 — Back up VMs from the first datastore only

Do only this for now:

Stay in Storage → Datastore browser
Open the first datastore (the one with most VMs)
Pick ONE VM folder (start with a non-critical one)
Right-click the VM folder → Download
Wait for the download to fully complete on your desktop

Do not download multiple VMs at once.


# Scripting
So copying each *-flat-vmdk file would take hours so we asked ChatGPT to make us a script.
It created a script that will search the datastores and pull each file that ends in .vm and will pull the main files we want out.
.vmx
.vmxf
.nvram
.vmdk

We saved the script to our local desktop in a backup folder and gave the location to ChatGPT. 

We logged into WinSCP and got the fingerprint from the session to plug into our script so it can authenticate.

Here's what WinSCP looks like 
<img width="1068" height="676" alt="image" src="https://github.com/user-attachments/assets/414b04f9-b92c-426d-9bb9-3352d5875b7a" />

Pretty clear view into the files that we want.

The script took some tweaking but otherwise seems like it's working.
We can let this run in the background while we finish setting up vCenter.

Also make sure to turn off sleep mode temporarily


# vCenter

We've downloaded VMWare-VCSA-all.802

Mount the iso
<img width="1419" height="300" alt="image" src="https://github.com/user-attachments/assets/c64879c8-3533-4c1f-8930-5a478d1528b5" />

<img width="477" height="357" alt="image" src="https://github.com/user-attachments/assets/44f100c3-07aa-4eef-8978-a38265438b83" />

<img width="1427" height="894" alt="image" src="https://github.com/user-attachments/assets/f7bc96b3-a24f-458c-989e-c93baa71cc41" />
<img width="1437" height="894" alt="image" src="https://github.com/user-attachments/assets/7d2127e8-a775-4654-a87c-b0bf8fefa61c" />
<img width="1423" height="888" alt="image" src="https://github.com/user-attachments/assets/3bc93d29-e17d-4292-8e1c-45478816ae6e" />
<img width="1421" height="890" alt="image" src="https://github.com/user-attachments/assets/e4c16d8a-4229-43ef-adb7-931554f2cde7" />
<img width="1025" height="813" alt="image" src="https://github.com/user-attachments/assets/89f58432-2f97-4f9d-9391-e7d65d3c1a4e" />

<img width="1029" height="815" alt="image" src="https://github.com/user-attachments/assets/e56a4622-c633-47a5-80a3-ad17fa68bb03" />

<img width="1028" height="815" alt="image" src="https://github.com/user-attachments/assets/c8c56fb7-3781-4600-948d-1dcc1ee8920c" />

Here we want to target our ESXi host 192.168.3.7
port 443
root:password123!

<img width="1018" height="821" alt="image" src="https://github.com/user-attachments/assets/03bb6bc3-3b72-47b1-91c0-1d50d21e7e49" />

<img width="1024" height="816" alt="image" src="https://github.com/user-attachments/assets/acc56e73-730e-4566-8d21-bd15dad3bce1" />

Left VM name as default
Password123!

<img width="1025" height="817" alt="image" src="https://github.com/user-attachments/assets/e6fbb477-8f9a-434c-b1b6-759bb5bcfc6c" />

Small deployment size
<img width="1026" height="819" alt="image" src="https://github.com/user-attachments/assets/a91e8594-63f6-47cf-ac4c-700118493b4e" />

We chose datastore2
<img width="1026" height="816" alt="image" src="https://github.com/user-attachments/assets/c69bf5fb-bc2c-4e9d-971c-f942956118b6" />

Leaving FQDN and DNS blank for now
<img width="1029" height="818" alt="image" src="https://github.com/user-attachments/assets/82f23f68-220d-43c7-aff3-4f159fa17933" />

When ready, click finish
<img width="1025" height="812" alt="image" src="https://github.com/user-attachments/assets/9413f66c-04a2-45c0-a2c8-0205964fb0c4" />

<img width="1028" height="814" alt="image" src="https://github.com/user-attachments/assets/c8e00301-5b76-4f05-947f-a3ad171bbde8" />

### Having some issues installing

Ending up having to use the CLI and create a script to run

<img width="935" height="32" alt="image" src="https://github.com/user-attachments/assets/e9bfe16c-0131-486d-ad56-1be3cf4a5b3a" />
<img width="585" height="209" alt="image" src="https://github.com/user-attachments/assets/454afe7e-140d-44db-9067-8f266e3282f2" />

<img width="333" height="596" alt="image" src="https://github.com/user-attachments/assets/2f26fe5b-f198-43ac-b414-3c4ab0e51d19" />

We also upgraded ESXi to enterprise to be able to have the license work with vCenter

We changed DNS to 0.0.0.0

Then went to our desktop and went to the https://192.168.3.8:5480
Had some issues trying to run the setup from inside a vm on the management port group but was able to run from desktop since it's a more stable enviornment (i.e. more stable dns)

Ran Stage 2 of the installer

Success!

<img width="1426" height="594" alt="image" src="https://github.com/user-attachments/assets/5b915267-112a-4016-b036-82459ed7ff9b" />

<img width="3427" height="1298" alt="image" src="https://github.com/user-attachments/assets/683484a1-da86-47dd-97f6-c0c8f4ee603a" />
<img width="3417" height="1296" alt="image" src="https://github.com/user-attachments/assets/2f45c4ac-d779-4ed8-a2e3-89b24582a3fd" />


### So this is the management page, to get to the vsphere client

https://192.168.3.8/ui

administrator@vsphere.local:Easypassword123
<img width="3428" height="1303" alt="image" src="https://github.com/user-attachments/assets/701be1bf-0281-4490-b87c-f3fc54dcecf1" />

New Datacenter
<img width="572" height="256" alt="image" src="https://github.com/user-attachments/assets/359efd47-e698-4c75-951c-5be2f327e36e" />

Add Host
<img width="3419" height="1289" alt="image" src="https://github.com/user-attachments/assets/6b6c1caa-da09-440f-a8bc-a7f329a9f58e" />

<img width="837" height="991" alt="image" src="https://github.com/user-attachments/assets/62bcaaad-a462-422b-abe9-3f42f01a3182" />

Credentials for ESXi so vCenter can have admin access
<img width="837" height="437" alt="image" src="https://github.com/user-attachments/assets/bf5249ce-a913-4807-bc9e-ee336b139544" />


<img width="590" height="398" alt="image" src="https://github.com/user-attachments/assets/e930b580-dd08-46bb-abe2-85a4433c943c" />

<img width="830" height="711" alt="image" src="https://github.com/user-attachments/assets/638dd1d0-4c63-4cec-ab61-a82a462a24d2" />

We'll uncheck "Manage host with an image" 
<img width="924" height="970" alt="image" src="https://github.com/user-attachments/assets/7782c894-968d-4f4b-b708-74b9fb7baccf" />

Select license 1
<img width="835" height="974" alt="image" src="https://github.com/user-attachments/assets/7f36cd0b-2920-4609-b21c-7bbfa8526df2" />

Disable Lockdown Mode
<img width="828" height="971" alt="image" src="https://github.com/user-attachments/assets/7c1279f7-42ed-4460-96b2-ec66213d7814" />

<img width="845" height="981" alt="image" src="https://github.com/user-attachments/assets/8bc50e15-4127-49ca-b751-210689261529" />

<img width="843" height="998" alt="image" src="https://github.com/user-attachments/assets/b844780f-39c3-474c-91d4-888b1ee942b9" />

<img width="3424" height="1276" alt="image" src="https://github.com/user-attachments/assets/16997e6e-8c7f-4fa1-9b0c-e6ffec3f272c" />

<img width="900" height="793" alt="image" src="https://github.com/user-attachments/assets/b1523d4c-8ae1-41e1-ae03-4d7fd48f120f" />

### Next Step Create a Cluster

Right-click Olympus > New Cluster
<img width="3426" height="1292" alt="image" src="https://github.com/user-attachments/assets/49f51064-6bf4-4241-97cf-5cf3ef6a6aa7" />

Turn off DRS, H and Management hosts with single image
<img width="836" height="968" alt="image" src="https://github.com/user-attachments/assets/f2128854-c7ea-49d8-901d-cd05455f5df6" />
<img width="837" height="982" alt="image" src="https://github.com/user-attachments/assets/81804d67-a49f-4da9-abc1-47771ef477a7" />

Now we have our cluster
<img width="3425" height="1283" alt="image" src="https://github.com/user-attachments/assets/eff2c65e-1357-4672-b5f9-4d5d3ac8a3b7" />

### Create a vSphere Distributed Switch (VDS) at the Datacenter (Olympus) level.

In the left tree, click Olympus (Datacenter) > Networks > Actions → Distributed Switch → New Distributed Switch
<img width="3426" height="1291" alt="image" src="https://github.com/user-attachments/assets/0580b5ad-08db-4f08-92f3-3dad638dace5" />

Right now, your host is still using standard vSwitches, which is totally normal at this stage.

<img width="754" height="370" alt="image" src="https://github.com/user-attachments/assets/dadfcba0-1e17-4894-b811-38d640c4cead" />

<img width="856" height="940" alt="image" src="https://github.com/user-attachments/assets/586f4565-aa84-4ef8-84ee-4d63d2a5dc22" />

### Step 1 — Create the distributed switch (safe step)

You must start from the Datacenter, not the host or the cluster.
In the left tree, click Olympus (the datacenter icon, not the cluster).
Click the Networks tab.
Click Distributed Switches.
Click Actions → New Distributed Switch.

You should now see a wizard.
<img width="1956" height="940" alt="image" src="https://github.com/user-attachments/assets/74de93f6-bff1-44e6-b7e9-bc03656cb099" />
<img width="874" height="723" alt="image" src="https://github.com/user-attachments/assets/40e48e29-2e7c-4c5e-8771-6e448592831a" />

### Step 2 — Wizard choices
Step 2 — Wizard choices
<img width="591" height="724" alt="image" src="https://github.com/user-attachments/assets/786b7f73-980f-4f0a-a52a-511de3757f02" />

<img width="863" height="718" alt="image" src="https://github.com/user-attachments/assets/e898b430-f724-450a-9bcf-f842d431301a" />

<img width="880" height="707" alt="image" src="https://github.com/user-attachments/assets/6bf21d61-7ee7-4f9c-9e90-a5d53a54fa6b" />
<img width="3408" height="513" alt="image" src="https://github.com/user-attachments/assets/b2eed6bc-b1a2-4b4c-90b3-c2f5510736f6" />


### Now we attach the ESXi host to the Distributed Switch.

Do this:

Click Olympus-DVS
Click Actions
Choose Add and Manage Hosts
Select Add host
Choose your ESXi host (192.168.3.7)
<img width="833" height="976" alt="image" src="https://github.com/user-attachments/assets/45abeea5-dc0b-4eff-be1c-eda39316581e" />

### Create a distributed port group specifically for monitoring
This port group will later be used by Security Onion
It will be set so traffic is copied, not forwarded inline


We'll create a monitoring-only port group on the distributed switch.

This port group:

Has no IP
Has no gateway
Is not management
Is where Security Onion will connect to sniff traffic

Do this next (slow + exact)

In vCenter, click Olympus (the datacenter)
Go to Networks
Click Distributed Port Groups
Click New Distributed Port Group

Here we have our DVS-Monitoring Port Group
<img width="3425" height="507" alt="image" src="https://github.com/user-attachments/assets/86c95dba-5ae4-489e-9b8b-d574fd79be9d" />

<img width="837" height="203" alt="image" src="https://github.com/user-attachments/assets/2e218be9-acbc-4d7b-9682-492c7f1d1b33" />

### Attach Security Onion’s monitoring network adapter to DVS-Monitoring

<img width="832" height="201" alt="image" src="https://github.com/user-attachments/assets/1c6fe0f3-04f5-4af9-b4a2-e0115b3e9170" />

From vCenter, add DVS-Monitoring NIC to Sec Onion Sensor and remove SPAN/TAP nic
<img width="3412" height="1289" alt="image" src="https://github.com/user-attachments/assets/1030e9d4-74f6-40c9-9344-60bc34841d2f" />

<img width="868" height="447" alt="image" src="https://github.com/user-attachments/assets/aed364ab-ae4a-4259-95c4-3f454da96b4d" />

### Okay let's test out what we've got


### We're going to add port groups to our distributed vswitch to generate traffic for Sec Onion

<img width="755" height="65" alt="image" src="https://github.com/user-attachments/assets/b82937d2-3f8a-4bea-b70d-3d8fd467687e" />

<img width="792" height="264" alt="image" src="https://github.com/user-attachments/assets/183ebd59-daa7-4d29-be09-f2626d643f87" />

<img width="854" height="1004" alt="image" src="https://github.com/user-attachments/assets/a6623d4d-a2d8-4eb7-b152-7ac0a0ef2eac" />

AND SO ON




################################
Step 1: Open the Sensor Console

In vCenter:
Select Security Onion Sensor
Click Console

Step 2: Confirm interfaces (MOST IMPORTANT)

ip addr

You should see:

One interface with an IP → this is Tools / management
One interface with NO IP → this is DVS-Monitoring (capture)

<img width="1644" height="985" alt="image" src="https://github.com/user-attachments/assets/248a61d0-ba04-410f-9f5a-d123874d149b" />

Second nic has MAC address from DVS-Monitoring
<img width="2944" height="930" alt="image" src="https://github.com/user-attachments/assets/5e4f546e-f53b-4067-bce0-5969d821ab1d" />

Step 3: Verify packet capture sees traffic

Still in the sensor console, run:

'sudo so-status'

<img width="887" height="532" alt="image" src="https://github.com/user-attachments/assets/41d9d28d-acba-4ed4-995d-b7996c3b9e05" />


Capture on the monitoring sensor

sudo tcpdump -i ens35


### In vSphere Client

Go to Olympus-DVS

Click Configure
Select Port mirroring (sometimes called Mirrored Ports depending on UI)

Do not create or edit anything yet — just confirm what exists.
<img width="754" height="438" alt="image" src="https://github.com/user-attachments/assets/902d6ba2-794a-46b0-b8b0-7dea934cdd26" />


<img width="875" height="319" alt="image" src="https://github.com/user-attachments/assets/91a12d49-e5f2-45b6-8bce-9b20d9c9002e" />

<img width="788" height="239" alt="image" src="https://github.com/user-attachments/assets/e969d807-7a4b-48d2-91e2-cb7171797c08" />


Step 1: Start a port mirroring session (do not change anything else)


### We had to do a one for one swap with the standard nic and the DVS nic for traffic visibility port mirroring

In vCenter:

Go to Olympus-DVS
Click Configure
Click Port mirroring
Click New (or Add)

That opens the Port Mirroring Session wizard.

Choose Distributed
<img width="861" height="1018" alt="image" src="https://github.com/user-attachments/assets/28a4ccbf-fc0b-4c7b-a17c-4824241989ac" />
<img width="840" height="1006" alt="image" src="https://github.com/user-attachments/assets/3b0ee011-eade-4039-9a79-74794baf1bfe" />


<img width="829" height="156" alt="image" src="https://github.com/user-attachments/assets/02221423-d9b1-49b9-8cab-aa6420ed8e3f" />

<img width="883" height="96" alt="image" src="https://github.com/user-attachments/assets/27daacf8-d901-45ce-b689-8c480d27bd26" />
<img width="825" height="973" alt="image" src="https://github.com/user-attachments/assets/99bf6daf-26bb-429c-bae4-f9725b460cce" />

<img width="853" height="972" alt="image" src="https://github.com/user-attachments/assets/9d184ba6-f3f9-4183-8dff-f1f44e6aa6b3" />


<img width="2733" height="966" alt="image" src="https://github.com/user-attachments/assets/c5dea3ab-2dbd-414b-8240-11af92327116" />

<img width="834" height="233" alt="image" src="https://github.com/user-attachments/assets/5398c58b-4d60-496e-8c66-d5de7e5729b7" />



### Packet Replay

<img width="808" height="233" alt="image" src="https://github.com/user-attachments/assets/aa13aec6-2ab6-4c47-97b7-2cac255d418f" />

So if we want to do packet replay, we'll have to create another instance of Security Onion
We're going to put this one in the Data Analysis port gorup and give it internet access.

<img width="944" height="588" alt="image" src="https://github.com/user-attachments/assets/cb585d8f-1e2b-46ef-ad86-b9277da16a3c" />

<img width="952" height="601" alt="image" src="https://github.com/user-attachments/assets/49998543-ef05-4bb0-81f0-f7dcafcf177a" />


<img width="999" height="623" alt="image" src="https://github.com/user-attachments/assets/9b987869-ac47-4567-81a1-9fe6b42e8a56" />

<img width="829" height="717" alt="image" src="https://github.com/user-attachments/assets/cd8d7d1a-f7c2-4b7e-ab6e-780d62149536" />



<img width="1626" height="1219" alt="image" src="https://github.com/user-attachments/assets/bb6505a3-ca42-4123-a05f-f5ff589d1ff8" />

<img width="1640" height="1211" alt="image" src="https://github.com/user-attachments/assets/7e7269ee-abd5-4b18-8f29-1f91c4028c01" />


<img width="1632" height="1211" alt="image" src="https://github.com/user-attachments/assets/a80da8a2-8c48-46c9-8a93-9943c41d9b0a" />

<img width="1631" height="1214" alt="image" src="https://github.com/user-attachments/assets/e6b02827-cfe9-4140-a54b-2fc52c021bac" />

<img width="1635" height="1224" alt="image" src="https://github.com/user-attachments/assets/7391217d-3624-4c2a-9aa7-dbfc077f8fc8" />

<img width="1630" height="1229" alt="image" src="https://github.com/user-attachments/assets/1a6d9144-8f45-4455-8d89-3838fa44ce54" />

<img width="1629" height="1218" alt="image" src="https://github.com/user-attachments/assets/7f7cab84-34a1-4950-afbc-f63ac3ce141a" />


<img width="830" height="343" alt="image" src="https://github.com/user-attachments/assets/1aa389b3-dece-4756-aa2d-8c5e3c45bd01" />

<img width="1627" height="1221" alt="image" src="https://github.com/user-attachments/assets/0484bad8-11a1-4669-bd8c-8d59873a96c8" />

<img width="832" height="726" alt="image" src="https://github.com/user-attachments/assets/4431e97e-a33a-4a33-84be-26940a56739c" />
<img width="1631" height="1222" alt="image" src="https://github.com/user-attachments/assets/ce5621d8-a8fb-4259-baa6-1cdb4d5f871e" />
<img width="1628" height="1211" alt="image" src="https://github.com/user-attachments/assets/2000c134-e411-4727-a2a5-904fb0319757" />
<img width="1628" height="1222" alt="image" src="https://github.com/user-attachments/assets/3aac4e4e-81af-4e28-8c3e-58b15a5d7361" />
<img width="1633" height="1217" alt="image" src="https://github.com/user-attachments/assets/d51fefd1-b66d-458e-9bb1-575ede4bb249" />

<img width="1626" height="1218" alt="image" src="https://github.com/user-attachments/assets/24fcff9d-d2cf-4d5e-80a7-a3dde2b216a2" />
<img width="1632" height="1214" alt="image" src="https://github.com/user-attachments/assets/cddd3635-9782-4345-b8b8-e3321767dc0c" />
<img width="1626" height="1217" alt="image" src="https://github.com/user-attachments/assets/fc421eae-c2f7-40f6-9783-49c09963a9df" />

<img width="1629" height="1213" alt="image" src="https://github.com/user-attachments/assets/a7ca4cea-d703-4699-bcf5-a883b6de58c5" />
<img width="1621" height="1201" alt="image" src="https://github.com/user-attachments/assets/6a440042-abfa-4948-887c-a8afc665399d" />

<img width="1625" height="1220" alt="image" src="https://github.com/user-attachments/assets/970f0d18-e660-4d21-b3c0-cb368421158c" />
<img width="1628" height="1218" alt="image" src="https://github.com/user-attachments/assets/6ca420d3-367a-4461-ac74-6aeaa0b92da5" />

<img width="1630" height="1213" alt="image" src="https://github.com/user-attachments/assets/2e948a34-f9b2-4eb2-a702-dd6433fd5a96" />

<img width="1631" height="1218" alt="image" src="https://github.com/user-attachments/assets/1b0c27ac-d080-44fa-96ec-ae8ee0cd2a42" />

Let's create other vm's in the data analysis port group (192.168.110.0/24) and use them to access the sec onion web gui. We can also give them internet access too so when we find pcaps and throw them directly into security onion

<img width="1629" height="1216" alt="image" src="https://github.com/user-attachments/assets/1625a123-e735-4cfe-9a69-dcdf4f94ac03" />

<img width="1662" height="1221" alt="image" src="https://github.com/user-attachments/assets/a1250d70-f995-4921-a40a-1995c10bd921" />


### Palo Alto firewall

#### Sec Onion
<img width="1139" height="394" alt="image" src="https://github.com/user-attachments/assets/0560d809-e529-4da6-9887-81714fe15346" />
<img width="1108" height="422" alt="image" src="https://github.com/user-attachments/assets/196e557e-9ee3-435e-9f99-8d0356e03664" />
<img width="1102" height="430" alt="image" src="https://github.com/user-attachments/assets/a3b88f30-f0bb-4d52-b295-3785d2fa2f24" />
<img width="1139" height="397" alt="image" src="https://github.com/user-attachments/assets/a4937a3f-bf6c-47a4-aa38-9591110fea24" />
<img width="1142" height="412" alt="image" src="https://github.com/user-attachments/assets/fad5eb13-38c9-48d8-ae73-599c82cdfe60" />
<img width="1161" height="417" alt="image" src="https://github.com/user-attachments/assets/2d241138-35be-47fa-adbf-17a1be83a6bb" />

Data-Analysis VM's
<img width="1083" height="383" alt="image" src="https://github.com/user-attachments/assets/ab5aca8d-e138-4ed0-8c8d-a613bf721a39" />
<img width="1095" height="421" alt="image" src="https://github.com/user-attachments/assets/c9ad5bbc-6822-4d52-9f4a-b49131f6b9e0" />
<img width="1075" height="417" alt="image" src="https://github.com/user-attachments/assets/0ce59d8e-c340-4dc4-97ae-bf1771690ea0" />
<img width="1094" height="396" alt="image" src="https://github.com/user-attachments/assets/e2f74cb1-72cd-43b0-b68e-ca114187cc74" />
<img width="1097" height="416" alt="image" src="https://github.com/user-attachments/assets/1fdc93ec-7764-4f8a-abab-3f53b60bb124" />
<img width="1079" height="357" alt="image" src="https://github.com/user-attachments/assets/6b89ae91-1c0e-45c3-b8e1-f203c79411e9" />



<img width="2718" height="660" alt="image" src="https://github.com/user-attachments/assets/15b7634d-f9f0-40a9-a120-8e719131779d" />



### Nat Rules
<img width="896" height="410" alt="image" src="https://github.com/user-attachments/assets/9ab53dbb-fe45-48f2-93cf-cc265bd0404e" />
<img width="1046" height="466" alt="image" src="https://github.com/user-attachments/assets/4e75b6f5-966e-47b3-8a3c-b85365db21ee" />
<img width="1009" height="542" alt="image" src="https://github.com/user-attachments/assets/a5f3ab5d-5418-46b5-bf7d-ed705fd5c750" />

***
PALO ALTO INHERENTLY DENIES PING SO HAVE TO PUT MANAGMENT PROFILE TO ALLOW PING
***

Changed native vlan on switch to 777
<img width="713" height="433" alt="image" src="https://github.com/user-attachments/assets/b5fb9f06-3a46-4bf7-8253-b9f58bab9747" />

### The Palo Alto needs a VLAN-tagged subinterface (ethernet1/2.777) because it cannot use a native VLAN on a Layer-3 port.

If you want, next step we can do just one thing:

Create ethernet1/2.777 together, cleanly, step by step.

Goal (keep this in your head)

We are going to:

Keep Gi0/1 as a trunk
Tag VLAN 777
Give the Palo Alto a VLAN subinterface that can actually talk on that trunk


Step 1 — Create the VLAN subinterface on the Palo Alto (nothing else yet)

On the Palo Alto GUI:
Go to Network → Interfaces → Ethernet
Click ethernet1/2
Click Add Subinterface (Bottom Left)
<img width="902" height="650" alt="image" src="https://github.com/user-attachments/assets/88d128c8-407a-4953-b1a9-8ff62401046a" />

Set:

Interface name: ethernet1/2.777
Tag: 777
Virtual Router: your existing VR (probably default)
Security Zone: EXTERNAL
<img width="771" height="493" alt="image" src="https://github.com/user-attachments/assets/d2cc67bf-0ad1-4e3d-9fb9-596bd0cacc17" />

IPv4 address: 192.168.1.253/24
<img width="729" height="493" alt="image" src="https://github.com/user-attachments/assets/bad500fc-3f18-4d7f-b695-250158589704" />
<img width="901" height="626" alt="image" src="https://github.com/user-attachments/assets/bc7d4347-2f11-4830-a7cc-a58b0e7854ef" />
<img width="783" height="364" alt="image" src="https://github.com/user-attachments/assets/53cb2794-addf-4a82-96a5-2c70b895b9f2" />
<img width="816" height="505" alt="image" src="https://github.com/user-attachments/assets/6ed43ceb-03ec-4c80-b852-743226c63128" />
<img width="1422" height="61" alt="image" src="https://github.com/user-attachments/assets/fff33243-7a56-437e-b31e-d95c7db57b71" />


Click OK

Commit

### Change VLAN ID

<img width="1144" height="694" alt="image" src="https://github.com/user-attachments/assets/50d11f86-a618-49eb-b70f-9a155460e444" />

### Turns out we do not have a nic attached to our vCenter switch
<img width="2446" height="1009" alt="image" src="https://github.com/user-attachments/assets/423f0673-fe96-44a4-8d84-7f6547634b74" />


Step 1 — Go to the Hosts tab of the DVS

Click Olympus-DVS
Click the Hosts tab (top row, next to Ports / VMs)
You should see:
Your ESXi host listed
Possibly “Not configured” or “0 uplinks”


Step 2 — Manage host networking

Select your ESXi host in the list
Click ACTIONS
Choose Add and Manage Hosts
Select Manage host networking

Click Next

<img width="1154" height="988" alt="image" src="https://github.com/user-attachments/assets/62fd1abc-90d1-4392-9b71-2e10f7c67fa6" />

Next
<img width="1156" height="989" alt="image" src="https://github.com/user-attachments/assets/83f73c87-6a31-4547-ad9d-51d0caadf36c" />



**

<img width="831" height="648" alt="image" src="https://github.com/user-attachments/assets/c8e22e0c-294b-41e6-8c55-7230aa50dd2c" />
<img width="1153" height="976" alt="image" src="https://github.com/user-attachments/assets/836d9380-30e0-4a6a-83a4-265ef6be2569" />
<img width="1152" height="976" alt="image" src="https://github.com/user-attachments/assets/d6209ef7-2db0-4c23-94d8-3080b5a27e84" />


Mamangement in ESXi has been migrated
<img width="3428" height="1107" alt="image" src="https://github.com/user-attachments/assets/f6d4838f-d072-4610-a2d3-7b2ffe1bb310" />

Did not move VM NIC0

<img width="864" height="298" alt="image" src="https://github.com/user-attachments/assets/d5f1995d-5c62-402d-99bd-329d21e7a365" />

### I'm going to call it a night and add naother vmnic to our topology.

### Second vmnic added

I'm pretty sure we changed previously changed our native vlan to 777 for security reasons.
let's change it back.

'conf t'
'interface gi0/1'
'switchport trunk native vlan 777'
'end'
'show interfaces trunk'

<img width="758" height="260" alt="image" src="https://github.com/user-attachments/assets/f606ba67-ef72-45a3-a962-e861c584577b" />


<img width="751" height="352" alt="image" src="https://github.com/user-attachments/assets/eebc0306-15e4-47fe-b137-8e6759450f6d" />

“VLAN 777 will remain unused and unrouted; all functional networks will be tagged VLANs.”
It exists only to catch untagged frames on trunks


<img width="790" height="209" alt="image" src="https://github.com/user-attachments/assets/942be08b-1356-4cc7-ad73-45f09bd891cd" />


<img width="797" height="98" alt="image" src="https://github.com/user-attachments/assets/0af5f481-4627-4fa9-99fa-8ef2d735a99f" />
<img width="425" height="168" alt="image" src="https://github.com/user-attachments/assets/089fdd9d-fe5f-44c2-b2ed-3de038b2daee" />

<img width="663" height="383" alt="image" src="https://github.com/user-attachments/assets/0566ce34-ce7c-4084-9e8c-9d2739d12a9c" />
<img width="1729" height="722" alt="image" src="https://github.com/user-attachments/assets/4c88b294-7860-4a9d-8232-7db38d407283" />

#### We need to add one physical uplink (vmnic) to the Distributed Switch

In vCenter:

Go to Networking
Select Olympus-DVS (your distributed switch)
Actions → Add and Manage Hosts
Select your ESXi host → Next
Choose Manage host networking
On Physical adapters, assign vmnic1 to Uplink 1
<img width="974" height="1027" alt="image" src="https://github.com/user-attachments/assets/74191bd4-09b2-48d0-ab7d-6f8b0a85d794" />

Next → Finish

Step 14d (proceed safely)

Click NEXT
On Manage VMkernel adapters:
Do NOT migrate anything
Leave everything unchecked / unchanged
Click NEXT

On Migrate VM networking:
Do NOT migrate anything

Click NEXT → FINISH

NIC added
<img width="826" height="914" alt="image" src="https://github.com/user-attachments/assets/816c9b24-f5d4-409e-b70d-629e3e17c1cc" />

<img width="877" height="607" alt="image" src="https://github.com/user-attachments/assets/d34dc76f-2388-4695-8f6b-d4e43dd4b0ce" />

<img width="734" height="349" alt="image" src="https://github.com/user-attachments/assets/c45da59e-f11c-4e0e-934b-32f97c7b038c" />


we deleted dvs-dmz nic


<img width="867" height="526" alt="image" src="https://github.com/user-attachments/assets/f90948c4-4947-45ea-b61d-1bc10408bca6" />

After deleting all additional NIC and leaving just management and external with the goal of trunking all traffic on external, we see traffic still coming in on ehternet1/1 which is legacy-internal

<img width="1842" height="1205" alt="image" src="https://github.com/user-attachments/assets/155da374-9185-41a7-ae2e-825b9be813f4" />
<img width="1813" height="772" alt="image" src="https://github.com/user-attachments/assets/75ad7339-fd4c-4d8a-b66a-04e1b9f1d941" />


<img width="903" height="621" alt="image" src="https://github.com/user-attachments/assets/ae0d809d-ff72-4837-af25-7930f46dda72" />


### NOPE


<img width="1190" height="503" alt="image" src="https://github.com/user-attachments/assets/ca72c4ce-3466-48d8-b694-cd93b4714193" />


### RESET



<img width="2766" height="373" alt="image" src="https://github.com/user-attachments/assets/25271777-b7d7-4556-b161-7813d0b311fb" />
So the next move is to add vmnic0 to the DVS, but without dropping management.



<img width="613" height="660" alt="image" src="https://github.com/user-attachments/assets/ec65b7ad-3574-4970-8d3c-75229a4d531c" />

Click ADD

You should now see:
Uplink 1
Uplink 2
Do not remove Uplink 1

Click OK

<img width="420" height="218" alt="image" src="https://github.com/user-attachments/assets/c3d9411a-be44-4369-bdf5-869861b8f87f" />


Step 7 — Attach vmnic0 to the DVS (safe, no outage)

We will add vmnic0 to the DVS, not remove anything yet.

<img width="777" height="428" alt="image" src="https://github.com/user-attachments/assets/d235e522-ed09-4ffb-9821-cfe25743fff0" />


<img width="926" height="987" alt="image" src="https://github.com/user-attachments/assets/3e3c89ee-589f-42a9-9811-9ba7f169bae1" />

<img width="905" height="991" alt="image" src="https://github.com/user-attachments/assets/11c46571-767d-456c-b5fb-f889e1150efd" />


<img width="895" height="965" alt="image" src="https://github.com/user-attachments/assets/2d664772-4285-4d75-9205-85ddb71d4279" />

<img width="768" height="331" alt="image" src="https://github.com/user-attachments/assets/11520b49-7d6d-47e2-81fd-6221135b3da9" />

<img width="937" height="1001" alt="image" src="https://github.com/user-attachments/assets/b975f433-5fe8-4fc6-a2e3-f1f47f38619f" />

Didn't work


<img width="928" height="613" alt="image" src="https://github.com/user-attachments/assets/b963a2e6-39fe-4adb-b06b-e70c72ba0e3e" />

<img width="856" height="706" alt="image" src="https://github.com/user-attachments/assets/762fb934-c802-427d-9b93-a9db99c7fa28" />

<img width="859" height="439" alt="image" src="https://github.com/user-attachments/assets/3f4c2560-54e2-4604-a2ed-78c2cd760454" />

<img width="2484" height="60" alt="image" src="https://github.com/user-attachments/assets/0bdc73e2-c1be-4479-b7be-ffe95c9aeed4" />

<img width="3408" height="1113" alt="image" src="https://github.com/user-attachments/assets/a0b41034-84d9-4f11-ab63-2075881a962e" />

<img width="811" height="358" alt="image" src="https://github.com/user-attachments/assets/000e6a11-c219-4044-8e6b-f981ddf77bf9" />

<img width="763" height="486" alt="image" src="https://github.com/user-attachments/assets/5cea10cd-781e-49a4-8703-cd6d86216408" />

<img width="951" height="896" alt="image" src="https://github.com/user-attachments/assets/ff3c2c9b-dcc2-4d86-9ee2-5636595d8141" />


<img width="1089" height="615" alt="image" src="https://github.com/user-attachments/assets/2c5b7302-304f-4018-90d7-1c23458dccac" />


<img width="927" height="741" alt="image" src="https://github.com/user-attachments/assets/8c59f1e5-48ad-419c-a2da-82d336f1c5d5" />

<img width="474" height="141" alt="image" src="https://github.com/user-attachments/assets/ee6483ff-4c44-40d8-bebc-2faf24649aa9" />

<img width="835" height="429" alt="image" src="https://github.com/user-attachments/assets/43b7c7ef-036f-45f2-ac44-d743f25f8ef3" />

<img width="1709" height="320" alt="image" src="https://github.com/user-attachments/assets/d80879d6-cf56-4cc0-998c-85282f3962f4" />


<img width="1022" height="202" alt="image" src="https://github.com/user-attachments/assets/aab56289-baf8-42cc-a4ae-813f446c4783" />

<img width="2432" height="73" alt="image" src="https://github.com/user-attachments/assets/d0fb8b17-02a4-417f-9431-5bcdf3001047" />


### Step 28 — Explicitly add vmnic0 to the DVS (no disruption)


<img width="827" height="519" alt="image" src="https://github.com/user-attachments/assets/be933ea5-654e-4952-adc3-3f12f913b87b" />

<img width="908" height="977" alt="image" src="https://github.com/user-attachments/assets/dea290a5-6e99-4707-875b-04a1ad0b7526" />


### Step B1 — Verify Palo Alto interfaces are UP and mapped correctly


### VM VLANs → Palo Alto → VLAN 777 → Cisco SVI (192.168.1.254) → Router (192.168.1.1) → Internet

Palo Alto will:
Have an outside IP in 192.168.1.0/24
Default route to 192.168.1.254
Perform NAT


Router - Statci Route
<img width="616" height="559" alt="image" src="https://github.com/user-attachments/assets/8bd64e42-cfdf-4f80-bcbb-8186a13ea4f9" />

### NAT

<img width="805" height="388" alt="image" src="https://github.com/user-attachments/assets/7447f58c-489d-4d44-ad82-ee8d9d14fb36" />
<img width="796" height="385" alt="image" src="https://github.com/user-attachments/assets/c449ec33-161d-4248-b3f6-bc02e3b1abee" />
<img width="794" height="295" alt="image" src="https://github.com/user-attachments/assets/ee46fb43-fbd0-44d3-804b-f6457a5668b9" />

We've bungled this and goign to revert back to our previous interface setup on Palo Alto





























